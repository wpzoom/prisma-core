!function(t){"use strict";wp.customize.controlConstructor["sinatra-widget"]=wp.customize.Control.extend({ready:function(){var i=this;i.widget_count=i.container.find(".widget").length,i.setupSortable(),i.container.on("click",".sinatra-widget-container .widget-top",function(){t(this).closest(".widget").toggleClass("sinatra-expanded").find(".widget-inside").slideToggle(200)}),i.container.on("click",".sinatra-widget-container .widget-control-close",function(){t(this).closest(".widget").toggleClass("sinatra-expanded").find(".widget-inside").slideToggle(200)}),i.container.on("click",".sinatra-add-widget",function(t){t.preventDefault(),i.updateList()}),i.container.on("change paste keyup","input, textarea, select",function(t){i.update()}),i.container.on("click",".widget-control-remove",function(){t(this).closest(".widget").remove(),i.update(),i.updateList()}),i.container.on("click",".sinatra-widget-edit-nav",function(){wp.customize.control("nav_menu_locations["+t(this).closest(".sinatra-widget-nav-container").data("menu-location")+"]").focus(),i.close()}),wp.customize.previewer.bind("url",this.close),t(i.container).find(".sinatra-widget-nav-container").each(function(){var a=t(this);i.bindMenuLocation(a)})},bindMenuLocation:function(t){var i=t.data("menu-location");wp.customize("nav_menu_locations["+i+"]",function(a){a.bind(function(a){if(a){var n=wp.customize.control("nav_menu_locations["+i+"]").container.find("option:selected").html();t.addClass("sinatra-widget-nav-has-menu").find(".sinatra-widget-nav-name").html(n)}else t.removeClass("sinatra-widget-nav-has-menu")})})},updateList:function(){var i,a=this,n=a.params.widgets;n?(t("#sinatra-available-widgets-list .sinatra-widget").hide().removeClass("disabled"),t.each(n,function(n,e){(i=t("#sinatra-available-widgets-list #sinatra-widget-tpl-sinatra_customizer_widget_"+n)).show(),e.hasOwnProperty("max_uses")&&e.max_uses>0&&e.max_uses<=t(a.container).find('.sinatra-widget-container [data-widget-type="'+n+'"]').length&&i.addClass("disabled")})):t("#sinatra-available-widgets-list .sinatra-widget").show()},addWidget:function(i){var a,n;n=this.setting.id+"-"+this.widget_count,a=(a=t.trim(t(this.container).find(".sinatra-widget-tpl-"+i).html())).replace(/<[^<>]+>/g,function(t){return t.replace(/__i__|%i%/g,n)});var e=t(a).appendTo(this.container.find(".sinatra-widget-container"));this.widget_count++,e.find(".widget-top").trigger("click"),this.update(),e.find(".sinatra-widget-nav-container").length&&this.bindMenuLocation(e.find(".sinatra-widget-nav-container"))},close:function(){t("body").removeClass("sinatra-adding-widget")},update:function(){var i,a,n,e,o,s=this.container.find(".sinatra-widget-container .widget"),d=[];s.length?(_.each(s,function(s){o=t(s),(a={}).classname=o.data("widget-base"),a.type=o.data("widget-type"),a.values={},i=o.find("input, textarea, select"),_.each(i,function(i){void 0!==(n=t(i).attr("data-option-name"))&&!1!==n&&(a.values[t(i).attr("data-option-name")]=t(i).val())}),_.each(o.find(".buttonset"),function(i){void 0!==(e=t(i).find('input[type="radio"]:checked'))&&!1!==e&&(a.values[e.data("option-name")]=e.val())}),d.push(a)}),this.setting.set(d)):this.setting.set(!1)},setupSortable:function(){var i=this;t(this.container).find(".sinatra-widget-container").sortable({items:"> .widget",handle:".widget-top",intersect:"pointer",axis:"y",update:function(){i.update()}})}}),t(document).ready(function(){var i;t(".wp-full-overlay").on("click",".sinatra-add-widget, .sinatra-close-widgets-panel",function(a){a.preventDefault(),t("body").toggleClass("sinatra-adding-widget"),t(this).data("location-title")&&(i=wp.customize.control(t(this).data("control")),t("#sinatra-available-widgets").attr("data-control",i.params.id).find(".sinatra-widget-caption").find("h3").html(t(this).data("location-title")))}),t(".wp-full-overlay").on("click",".customize-section-back",function(i){t("body").removeClass("sinatra-adding-widget"),t("#sinatra-available-widgets").removeAttr("data-control")}),t("#sinatra-available-widgets").on("click",".sinatra-widget",function(a){i=wp.customize.control(t("#sinatra-available-widgets").attr("data-control"));var n=t(this).data("widget-id");i.addWidget(n);i.close()})})}(jQuery);